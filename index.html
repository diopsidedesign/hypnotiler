<!doctype html>
<html lang="en">  

   <head>
      
      <meta charset="utf-8">
      <base href="https://diopsidedesign.github.io/hypnotiler/" >
      <meta name="viewport" content="width=device-width, initial-scale=1" >
      <meta name="description" content="hypnotiler by diopside" >
      <meta name="author" content="diopside design" >    
      
      <title>hypnotiler</title>  

   </head> 

   <style>

      :root {   
        --image-url: url(default_image.jpg);  
        --image-position: 0px 0px;
        --tile-width: 240px; 
        --button-size: 2rem;
        --image-scale: 250%;
        --zoom-amount: 100%;        
        --image-rotation:  0deg;
        --canvas-rotation: 0deg; 
        --pan-x: 0px;
        --pan-y: 0px;
      } 
       
      html, body {
         font-family: sans-serif;
         margin: 0;
         padding: 0;
      } 
         
      body {   
         line-height: var(--button-size); 
         position: fixed; 
         box-sizing: border-box; 
         overflow: hidden hidden; 
         width: 100vw;  
         min-height: 100dvh;
         height: 100%;
         display: flex; 
         flex-flow:  row nowrap;     
      }

      .inner-wrapper { 
         width: 100%;   
         position: absolute;  
         overflow-x: hidden;  
         overflow-y: auto; 
         height: 100%;
      }
       
      #dash,
      #main,
      .inner-wrapper,
      #dash-handle {  
         min-height: 100%;
         box-sizing: border-box;
      }

      #dash, #main {   
         position: relative; 
         overflow-x: hidden; 
         overflow-y: auto; 
         touch-action: none;  
      }
 
      #main {  
         z-index: 10;  
         margin-left: 1rem; 
         flex: 1 1 auto;   
      } 

      #main > .inner-wrapper {  
         width: 100%;  
         height: 100%; 
         top: 0;
         left: 0; 
         overflow: hidden hidden;  
      } 

      #dash {    
         color: white;
         background-color: rgba( 0,0,0, .5);
         backdrop-filter: blur(2rem);  
         -webkit-backface-visibility: hidden;
         -webkit-perspective: 1000;
         -webkit-transform: translate3d(0,0,0);
         -webkit-transform: translateZ(0); 
         perspective: 1000;
         transform: translate3d(0,0,0);
         transform: translateZ(0); 
         backface-visibility: hidden; 
         -webkit-user-select: none;
         user-select: none;
         width: 0px;
         z-index: 26;
         flex: 0 0 auto;   
         max-width: 100vw;
         transition: width 500ms ease-in-out,  
                     box-shadow 1000ms ease-in-out; 
      } 

      #dash::-webkit-scrollbar {
         display: none;
      }

      #dash-handle {   
         flex: 0 0 1rem;  
         cursor: col-resize;   
         width: 1rem;     
         z-index: 32;
         margin-right: -2rem; 
      } 

      #dash-handle .inner-wrapper { 
         width: 1rem;  
         display: flex;
         flex-flow: column nowrap;
         transform: translateX(0px);
         position: absolute; 
         touch-action: none;
         clip-path: inset(0 0 0 0);
      }

      #dash-handle .inner-wrapper::before {
         content: "";
         pointer-events: none;
         position: absolute;
         transform: translateX(0%);
         height: 100%; 
         width: 1rem;  
         transition: transform 100ms ease-in-out;
         background: linear-gradient(to left,
            rgba(0, 0, 0,  0) 10%,
            rgba(0, 0, 0,.05) 50%,
            rgba(0, 0, 0,.13) 75%,
            rgba(0, 0, 0,.23) 95%);
      } 

      #dash > .inner-wrapper {
         padding: 1rem;
         display: flex; 
         flex-flow: column nowrap;   
         justify-content: start;
         transition: transform  500ms ease-in-out;  
      }  
 
      #menu-button { 
         position:   absolute; 
         box-sizing: content-box;
         top: min(5%, 1.2rem);
         margin-left: min(5%, 1.2rem);
         height: 2.1rem;
         width: 2.5rem; 
         padding: 1rem;
         border-radius: 16%; 
         z-index: 33;
         cursor: pointer;   
         fill: white;
         stroke: white;
         background-color: rgba(0, 0, 0, .5);
         transition: transform 500ms ease-in-out, 
                     filter 100ms linear 440ms,
                     opacity 500ms ease-in-out,
                     background-color 220ms ease-in-out;
         transform: translate(0, 0); 
      } 
 
      #menu-button button[menu] { 
         height: 100%;   
         width: 100%;
         color: inherit;
         fill: inherit;
         padding: 1rem;
         margin: -1rem -1rem;
         stroke-opacity: 0;
         position: relative;
         cursor: pointer;  
         background-color: transparent;
         overflow: visible; 
         box-sizing: content-box;
         border: none;
         outline: none;
         appearance: none; 
      } 

      body[dash-open] #menu-button {        
         transition: transform 500ms ease-in-out,
                     opacity 500ms ease-in-out,
                     filter 100ms linear 0ms, 
                     background-color 230ms ease-in-out;
         opacity: .5;
         background-color: transparent;
         transform: translate(calc(-5.6rem + .3rem), calc(-1.66rem + .3rem)) scale(1);
      }  
       
      #menu-button button[menu] svg.icon {
         transition: transform 150ms ease-in-out;
      } 

      #menu-button button[menu] svg.icon rect.menu-piece { 
         stroke-width: 1px;
         stroke-opacity: 1;  
         stroke: white!important;
         transform: scale(1,1) rotate(0deg);
         transition: transform 500ms linear;  
         transform-origin: center center 0;
      }

      body[dash-open] #menu-button button[menu] .icon {
         rect.menu-piece.top    {  transform: translate(7px, 7px) rotate(-45deg)!important; }
         rect.menu-piece.middle {  transform: scale(0,0)!important;  }
         rect.menu-piece.bottom {  transform: translate(7px, -7px) rotate(45deg)!important; }
      } 

      body.no-transitions #dash,
      body.no-transitions #dash > .inner-wrapper,
      body.no-transitions #main,  
      body.window-resizing * { 
         transition: none!important;
      } 

      .checkered-background { 
         background-image:  
             linear-gradient(to right, rgba(250, 250, 250, 0.85), rgba(250, 250, 250, 0.85)), 
             linear-gradient(to right, gray 50%, white 50%),
             linear-gradient(to bottom, gray 50%, white 50%);
         background-blend-mode: normal, difference, normal;
         background-size: 1em 1em;
      }

      /* ************************************************************* */


      body[active-tool="move"] #main >.inner-wrapper {
         cursor: grab;
      } 

      body[active-tool="pan"] #main >.inner-wrapper {
         cursor: move;
      } 


      /**/

 

      /**/

      button:not([menu]),
      input[type="radio"], 
      input[type="checkbox"],
      .image-control-group {
         appearance: none;
         color: white;
         cursor: pointer;  
         position: relative;   
         display: inline-block;
         vertical-align: middle;
         width: var(--button-size);
         aspect-ratio: 1 / 1;
         max-height: 100%;
         background-color: rgb(255 255 255 / .1);
         border-radius: .2rem;
         outline: 0.1rem solid rgb(0 0 0 / .1); 
         box-shadow: rgb(0 0 0 / .4)       -1px -1px 1px 1px inset,
                     rgb(255 255 255 / .1)  1px  1px 1px 1px inset; 
      }

      .image-control-group:hover ,
      .toolbar button:hover,
      input[type="radio"]:hover {
         background-color: rgb(255 255 255 / .2);
         outline: 0.1rem solid rgb(0 0 0 / .2); 
         box-shadow: rgb(0 0 0 / .3)       -1px -1px 1px 1px inset,
                     rgb(255 255 255 / .2)  1px  1px 1px 1px inset; 
      }
      
      button:not([menu]) {          
         margin: 0;  
         border: none;    
      }
 
      button:not([menu]):active,
      .image-control-group[active],
      button:not([menu])[active],
      input[type="radio"]:checked,
      input[type="checkbox"]:checked {
         box-shadow: rgb(0 0 0 / .4)         1px  1px 1px 1px inset,
                     rgb(255 255 255 / .1)  -1px -1px 1px 1px inset; 
         background-color: rgb(0 0 0 / .1); 
      }

      .image-control-group[active],
      .toolbar button:active,
      .toolbar button[active] {
         box-shadow: rgb(0 0 0 / .4)         0px  1px 1px 1px inset,
                     rgb(255 255 255 / .1)   0px -1px 1px 1px inset; 
            border-right:2px solid rgb(0 0 0 / .5);
          background-color: rgb(255 255 255 / .2);
      } 

      button:not([menu]) svg {
         position: relative;
         height: 100%;
         width: 100%;
         fill: inherit;         
      } 

      button:not([menu]) svg path {
         fill: currentcolor;
      }

      button:not([menu]):active svg,
      button:not([menu])[active] svg { 
         top:  1px;
         left: 1px; 
      } 
 
      
      label,span { 
         margin: 0;
         display: inline-block;
         padding: 0; 
      } 
 
       value-incrementer, range-input {
         --button-size: 1.6rem;
      }

      fancy-checkbox  {
         --button-size: 1.4rem;
      }
       
      input[type="radio"] { 
         display: inline-block;
         margin: 0;
         padding: 0;    
         width: calc(var(--button-size) / 1.4);
         border-radius: 50%; 
      }  

      input[type="radio"]::after {
         content: "";
         border-radius: 50%;
         position: absolute;
         height: 50%;
         width: 50%;
         top: calc(25% + 1px);
         left: calc(25% + 1px);
         background-color: currentcolor;
         transform: scale(0);
         transition: transform 100ms ease-in-out;
      }

      input[type="radio"]:checked::after { 
         transform: scale(1);
      }


      .toolbar {
         display: inline-flex;
         flex-flow: row nowrap;
         width: 100%;
         height: 2.8rem; 
      }

      .toolbar > button {
         border-radius: 0px;             
         flex: 1 0 4rem;          
      }

      .toolbar > button::after { 
         opacity: .8; 
         content : attr(tool-name);
         position: absolute;
         top: 110%;

         left: 0%;
         width: 100%;
         visibility: hidden;  
      }

      .toolbar > button[active]::after {
         visibility: visible;
      }

      .toolbar > button:first-child {
         border-top-left-radius: 10px;
         border-bottom-left-radius: 10px;
      }

      .toolbar > button:last-child {
         border-top-right-radius: 10px;
         border-bottom-right-radius: 10px;
      }

      .toolbar > button > svg {
         min-width: 20px;
         height:50%;
         pointer-events: none;
      }

      .toolbar > button > svg path {
         pointer-events: none;
      }

      /* wrapper divs for the kaleidoscope component that help w/ transforms */
      /* easier to apply single transforms to single divs rather than repeatedly
      /* trying to retweak one complex transform */
      .app-wrap,
      .app-wrap > div {
         width: 100vw;
         height: 100vh;
         z-index: 0; 
         top: 0; left: 0; 
      }

      .app-wrap       { position: absolute; }
      .app-wrap > div { position: relative; }

      #translate-wrap-inner {
         transform: translateX(var(--pan-x)) translateY(var(--pan-y));
      } 

      #zoom-wrap-inner {
         transform: scale(var(--zoom-amount));
      }

      hypno-tiler {
         transform: rotate(var(--canvas-rotation));
      }
       
      label.checkbox-label { 
         vertical-align: middle;
         height: var(--button-size);
         display:inline-block;
         position: relative; 
         width: min-content;
         flex: 0 1 auto; 
         font: inherit; 
      } 

      #row-col-incrementers {
         margin-top: 1rem;
      }

      #row-col-incrementers > div {
         margin-top: .5rem;
      }

      #row-col-incrementers > div span:not(:first-child) { 
         flex: 0 0 auto; 
         display: inline-block; 
         text-align: right;
         width: 18px;
      }

      #row-col-incrementers > div span:first-child {
         display: inline-block;  
         width: 64px; 
      } 

      #row-col-incrementers > div value-incrementer {
         margin-left: 2px;
         flex: 0 0 auto;   
      }
 
      label[for="canvas-tools-toolbar"] {
         text-align: center; 
         width: 100%;  
      } 
 
      .dash-section {
         margin: 0 0 1rem 0;
      }

      .credits {
         width: 100%;
         text-align: center;
         opacity: .5; 
         font-size: 80%;
         line-height: 1.3rem; 
         margin-bottom: 0;
      }
         
      .spacer-section {
         height: 100%;
      }

      

      #mirror-radio-select > div {
         display: inline-block;
      }

      #mirror-radio-select > div > input {
         margin-left: .3rem;
      }

      #mirror-radio-select > div > label {
         margin-right: 1rem;
      }
      #mirror-radio-select > div:last-child > label {
         margin-right: 0rem;
      }
     .section-title, .title-section {   
         margin: .4rem 0 .4rem 0; 
         font-size: 95%;
         font-weight: bold;
         opacity: 0.8;
          position: relative;
         width: 100%;
      }

     .title-section {  
         
         font-size: 110%;
         margin-top: 0!important;
         font-family: monospace;
         opacity: .7;
         text-transform: lowercase;
         letter-spacing: 2px;
         display: block;  
         text-align: center;
     }
    
      .animate-properties-group.control-section > div {
         display: inline-block; 
         margin-right: 1rem;
      }  

      .animate-properties-group.automode-enabled div:not(.auto-toggle) label,
      .animate-properties-group.automode-enabled div:not(.auto-toggle) span {
         opacity: .5!important;
      }

      input[type="radio"] + label {
         font-weight: normal;
      } 

      .github-icon {
         display: inline-block;
         max-width: 1.5rem;
      }

      .github-icon svg {
         position: relative;
         width: 100%; 
      }

      .app-wrap.last {
         display: grid;
         place-content: center;
      } 

      hypno-tiler[reflect="6"],
      hypno-tiler[reflect="12"] {
         margin-top: calc(var(--tile-width) / 2);
      }

      #edit-image-controls > *:first-child {
         border-top-left-radius: 10px;
         border-top-right-radius: 10px;
      }

      #edit-image-controls > *:last-child {
         border-bottom-left-radius: 10px;
         border-bottom-right-radius: 10px;
      }

      #edit-image-controls > * {
         width: 100%; 
         box-sizing: border-box;
      }
       
      .image-control-group {
         border-radius: 0;
         aspect-ratio: initial;
      }

      .image-control-group > * {
         box-sizing: border-box;
      }

      .image-control-group > .display-section { 
         font-size: 95%;
         position: relative;
         width: 100%;
         padding: 0;
      } 

      .image-control-group > .control-section {
         position: relative;
      } 

      .image-control-group > .display-section > div {
         padding: .4rem .5rem .4rem 1rem;
         display: block;  
         display: flex;
         flex-flow: row nowrap;
         width: 100%;
      }

      .image-control-group > .display-section > div > span:first-child {
         opacity: .8;
         flex: 0 0 9rem;    
         font-size: 95%;
         display: inline-block;
      }

      .image-control-group[active] > .display-section > div > span:first-child {
         opacity: 1;
      }

      .image-control-group > .display-section > div > span + span{
         display: inline-block;
      } 
      
      .image-control-group > .control-section {
         padding: 0;
         visibility:  hidden;
         height: 0;        
      }
      
      .image-control-group[active] > .control-section {
         padding: 0 .5rem .5rem .5rem;    
         visibility:  visible; 
         height: auto;
         font-size: 90%;
      }

      #pattern-size-control > .control-section > div {
       display: inline-block;  
      }

      #pattern-size-control > .control-section > div + div {
        margin-left: .5rem;
      }

      .auto-toggle {
         display:block!important;
      }

      .display-section svg {
         min-width: 20px;
         margin-left:10px;
      }


      #edit-image-button,
      #image-url-button { 
         display: inline-block; 
         margin-left: 1rem;
      } 
      #edit-image-button svg,
      #image-url-button svg {
         fill: white;
         opacity: .7;
         position: relative;
         top: 2px;
         min-width: 18px;
      }
      #image-url-button:hover,
      #edit-image-button:hover {
         transform: scale(1.1);
      }
      #image-url-button:hover svg,
      #edit-image-button:hover svg {
         opacity: 1
      }


      
      
   </style>












   <body class="checkered-background" > 

      <div id="dash">

         <div id="inner-dash" class="inner-wrapper">    

            <div class="title-section"><span>Hypnotiler 0.4</span></div>
            
            <div class="section-title">
               Source Image
               <div id="edit-image-button">  
                  <svg  viewBox="0 0 28 28">
                     <path d="M26 9v16c0 2-1 3-3 3H3c-2 0-3-1-3-3V5c0-2 1-3 3-3h16l-3 3H5C3 5 3 5 3 7v16c0 2 0 2 2 2h16c2 0 2 0 2-2V12l3-3ZM9 14 20 3c2 0 5 3 5 5L14 19l-6 2H7v-1l2-6Zm.5 1-1 3c1 0 1.5 1.5 1.5 1.5l3-1C13 17 11 15 9.5 15Zm.5-1h1L21 4h-1L10 14ZM28 4c0 1-1 2-1 2l-1.5 1.5c0-2-3-5-5-5L22 1s1-1 2-1c2 0 4 2 4 4Z"/>
                  </svg>
               </div>
            </div>
            
            
            <div class="img-upload-frame">
               <image-uploader start-open class="checkered-background dash-section"></image-uploader>
            </div>
         
            <div class="section-title">Canvas Tools</div>
            <div id="canvas-tools-toolbar" class="dash-section toolbar"> 
               <button active tool-name="Move" type="button">
                  <svg viewBox="0 0 56 57"><path d="M45.7 8.2c.7-.3 1.7-.4 2.7-.4 7.5 0 7.5 7.5 7.5 7.5V36a22 22 0 0 1-7.8 16.5c-3 2.6-6.6 4-9.7 4H23.5c-.8 0-10.1.3-18.2-12.1A30 30 0 0 1 0 28.5c0-3.6 1-6.7 3-9 1.9-2 4.4-3.4 8-3.8V10s0-7.5 7.4-7.5a8 8 0 0 1 3.7.8C23.1 1.6 25 0 28.4 0c3.5 0 5.3 1.6 6.3 3.3a8 8 0 0 1 3.7-.8c5.1 0 6.7 3.4 7.3 5.7ZM10.9 20.7c-8.2 1.7-7.2 12-1.4 21 6.6 10 13.8 9.8 13.8 9.8h15.1c2.1 0 4.4-1.1 6.5-2.9 3.3-2.8 6-7.4 6-12.6V15.2s0-2.4-2.5-2.4C46 12.8 46 14 46 15.2a2.5 2.5 0 1 1-5 0V10s0-2.5-2.5-2.5S36 10 36 10v5.5a2.5 2.5 0 0 1-5 0v-8S31 5 28.4 5 26 7.5 26 7.5v7.8a2.5 2.5 0 0 1-5 0V10s0-2.5-2.5-2.5S16 10 16 10v15a2.5 2.5 0 0 1-5 0v-4.3Z"/></svg>
               </button>
               <button tool-name="Twist" type="button">
                  <svg viewBox="0 0 280 309"><path d="M145 0v26h-10V0h10Zm0 45v26h-10V45h10Zm0 89v26h-10v-26h10Zm0-44v26h-10V90h10Zm0 149v26h-10v-26h10Zm0 44v26h-10v-26h10ZM0 130v-4c0-24 52-44 120-48v30c-54 3-98 16-111 34-1 1-9-12-9-12Zm0 38v-23c6 15 46 30 95 36v32c-55-6-95-24-95-45Zm175-9v24c54-5 98-21 105-38v23c0 22-45 41-105 46v25l-62-40 62-40Zm-15-81c68 4 120 24 120 48v4s-8 13-9 12c-13-18-56-31-111-34V78Z"/></svg>
               </button>
               <button tool-name="Pan" type="button">
                  <svg viewBox="0 0 50 50"><path d="m0 25 10-9v5h11V10h-5l9-10 9 10h-5v11h11v-5l10 9-10 9v-5H29v11h5l-9 10-9-10h5V29H10v5L0 25Z"/></svg>
               </button>  
            </div>

            <div class="dash-section"></div>

            <div class="section-title">Settings</div>
            <div id="image-slider-controls" class="dash-section">
               <div id="edit-image-controls">
                  <div class="image-control-group" active>
                     <div class="display-section"> 
                        <div>
                           <span>Num. of Mirrors</span>
                           <span id="reflect-value-display"></span>   
                        </div>                        
                     </div>
                     <div class="control-section">
                         <div id="mirror-radio-select">
                           <div>
                              <input autocomplete="off" type="radio" id="mirror4" name="age" value="4">
                              <label for="mirror4">4</label>
                           </div>                              
                          <div>
                              <input autocomplete="off" checked type="radio" id="mirror6" name="age" value="6">
                              <label for="mirror6">6</label>
                           </div>
                          <div>
                              <input autocomplete="off" type="radio" id="mirror8" name="age" value="8">
                              <label for="mirror8">8</label>
                           </div>
                          <div>
                              <input autocomplete="off" type="radio" id="mirror12" name="age" value="12">
                              <label for="mirror12">12</label>
                           </div>
                        </div> 
                     </div>                     
                  </div>
                  <div class="image-control-group">
                     <div class="display-section"> 
                        <div>
                           <span>Image Scale</span>
                           <span id="image-scale-value-display"></span>   
                        </div>                        
                     </div>
                     <div class="control-section">
                        <range-input id="image-scale-input-slider" unit="%" min="20" max="600" step="1" value="250"> 
                        </range-input>      
                     </div>                     
                  </div>
                  <div class="image-control-group">
                     <div class="display-section"> 
                        <div>
                           <span>Tile Size</span>
                           <span id="tile-width-value-display"></span>
                        </div>
                     </div>
                     <div class="control-section">
                        <range-input id="tile-width-input-slider" unit="px" min="80" max="1280" step="2" value="240"> 
                        </range-input>
                     </div>
                  </div>
                  <div id="animate-control-group" class="image-control-group">
                     <div class="display-section">
                        <div>
                           <span>Animate</span>
                           <span id="animate-value-display"></span>
                        </div>
                     </div>
                     <div class="animate-properties-group control-section">
                        <div class="auto-toggle">
                           <fancy-checkbox checked id="animate-auto-toggle"></fancy-checkbox>  
                           <span>Auto</span>
                        </div>
                        <div>
                           <fancy-checkbox id="animate-x-toggle"></fancy-checkbox>
                           <span>X</span>
                        </div> 
                        <div>
                           <fancy-checkbox id="animate-y-toggle"></fancy-checkbox>
                           <span>Y</span>
                        </div> 
                        <div>
                           <fancy-checkbox id="animate-rotate-toggle"></fancy-checkbox>  
                           <span>Rotate</span>
                        </div> 
                     </div>
                  </div>
                  <div id="pattern-size-control" class="image-control-group">
                     <div class="display-section">
                        <div>
                           <span>Pattern Size</span>
                           <span>
                              <span id="rows-display"></span>
                              <span>&nbsp;x&nbsp;</span>
                              <span id="columns-display"></span>
                           </span>
                        </div>
                     </div>
                     <div class="control-section"> 
                        <div>
                           <span>Rows</span>  
                           <value-incrementer id="rows-incrementer"></value-incrementer>
                        </div>  
                        <div>
                           <span>Columns</span>  
                           <value-incrementer id="columns-incrementer"></value-incrementer>
                        </div>
                     </div>
                  </div>
                  <div class="image-control-group">                  
                     <div class="display-section"> 
                        <div>
                           <span>Zoom</span>
                           <span id="zoom-amount-value-display"></span>   
                        </div>                        
                     </div>
                     <div class="control-section">
                        <range-input id="zoom-amount-input-slider" unit="%" min="10" max="500" step="2" value="100"> 
                        </range-input>
                     </div>
                  </div>
                  <div class="image-control-group">
                     <div class="display-section"> 
                        <div>
                           <span>Rotate</span>
                           <span id="canvas-rotation-value-display"></span>   
                        </div>                        
                     </div>
                     <div class="control-section">
                        <range-input id="canvas-rotation-input-slider" unit="deg" min="-360" max="360" step="15" value="0"> 
                        </range-input>
                     </div>
                  </div> 
                  
               </div>
 
            </div>

            
       

            <div class="dash-section spacer-section">               
            </div>

            <div class="dash-section credits" >
               <div class="github-icon" >
                  <a href="https://github.com/diopsidedesign">
                     <div >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 439 428" >
                           <path d="M409.132,109.208c-19.608,-33.596 -46.205,-60.194 -79.798,-79.8c-33.598,-19.607 -70.277,-29.408 -110.063,-29.408c-39.781,0 -76.472,9.804 -110.063,29.408c-33.596,19.605 -60.192,46.204 -79.8,79.8c-19.605,33.595 -29.408,70.281 -29.408,110.057c0,47.78 13.94,90.745 41.827,128.906c27.884,38.164 63.906,64.572 108.063,79.227c5.14,0.954 8.945,0.283 11.419,-1.996c2.475,-2.282 3.711,-5.14 3.711,-8.562c0,-0.571 -0.049,-5.708 -0.144,-15.417c-0.098,-9.709 -0.144,-18.179 -0.144,-25.406l-6.567,1.136c-4.187,0.767 -9.469,1.092 -15.846,1c-6.374,-0.089 -12.991,-0.757 -19.842,-1.999c-6.854,-1.231 -13.229,-4.086 -19.13,-8.559c-5.898,-4.473 -10.085,-10.328 -12.56,-17.556l-2.855,-6.57c-1.903,-4.374 -4.899,-9.233 -8.992,-14.559c-4.093,-5.331 -8.232,-8.945 -12.419,-10.848l-1.999,-1.431c-1.332,-0.951 -2.568,-2.098 -3.711,-3.429c-1.142,-1.331 -1.997,-2.663 -2.568,-3.997c-0.572,-1.335 -0.098,-2.43 1.427,-3.289c1.525,-0.859 4.281,-1.276 8.28,-1.276l5.708,0.853c3.807,0.763 8.516,3.042 14.133,6.851c5.614,3.806 10.229,8.754 13.846,14.842c4.38,7.806 9.657,13.754 15.846,17.847c6.184,4.093 12.419,6.136 18.699,6.136c6.28,0 11.704,-0.476 16.274,-1.423c4.565,-0.952 8.848,-2.383 12.847,-4.285c1.713,-12.758 6.377,-22.559 13.988,-29.41c-10.848,-1.14 -20.601,-2.857 -29.264,-5.14c-8.658,-2.286 -17.605,-5.996 -26.835,-11.14c-9.235,-5.137 -16.896,-11.516 -22.985,-19.126c-6.09,-7.614 -11.088,-17.61 -14.987,-29.979c-3.901,-12.374 -5.852,-26.648 -5.852,-42.826c0,-23.035 7.52,-42.637 22.557,-58.817c-7.044,-17.318 -6.379,-36.732 1.997,-58.24c5.52,-1.715 13.706,-0.428 24.554,3.853c10.85,4.283 18.794,7.952 23.84,10.994c5.046,3.041 9.089,5.618 12.135,7.708c17.705,-4.947 35.976,-7.421 54.818,-7.421c18.842,0 37.117,2.474 54.823,7.421l10.849,-6.849c7.419,-4.57 16.18,-8.758 26.262,-12.565c10.088,-3.805 17.802,-4.853 23.134,-3.138c8.562,21.509 9.325,40.922 2.279,58.24c15.036,16.18 22.559,35.787 22.559,58.817c0,16.178 -1.958,30.497 -5.853,42.966c-3.9,12.471 -8.941,22.457 -15.125,29.979c-6.191,7.521 -13.901,13.85 -23.131,18.986c-9.232,5.14 -18.182,8.85 -26.84,11.136c-8.662,2.286 -18.415,4.004 -29.263,5.146c9.894,8.562 14.842,22.077 14.842,40.539l0,60.237c0,3.422 1.19,6.279 3.572,8.562c2.379,2.279 6.136,2.95 11.276,1.995c44.163,-14.653 80.185,-41.062 108.068,-79.226c27.88,-38.161 41.825,-81.126 41.825,-128.906c-0.01,-39.771 -9.818,-76.454 -29.414,-110.049Z" style="fill:#fff;fill-rule:nonzero;"/>
                        </svg>
                     </div>
                  </a> 
               </div> 
               <div>©2024 diopside design</div>
               
            </div> 
         </div>  
      </div>

      <div id="dash-handle">  
         <div id="menu-button">
            <button title="Open Dash Button" menu>
               <svg class="icon"
                    viewBox="0 0 30 26"
                    xmlns="http://www.w3.org/2000/svg"
                    preserveAspectRatio="xMidYMid meet">
                   <rect class="menu-piece top"    x="1"  y="1" width="28" height="4" rx="2" ry="2"/>
                   <rect class="menu-piece middle" x="1" y="11" width="28" height="4" rx="2" ry="2"/>
                   <rect class="menu-piece bottom" x="1" y="21" width="28" height="4" rx="2" ry="2"/>
               </svg>
            </button>
         </div>
         <div class="inner-wrapper"></div>
      </div>

      <div id="main">  
         <div class="inner-wrapper">  
         </div> 
      </div> 

      <div class="app-wrap">
         <div id="zoom-wrap-inner">
            <div class="app-wrap">
               <div id="translate-wrap-inner">
                  <div class="app-wrap last"> 
                     <hypno-tiler reflect="6"></hypno-tiler>
                  </div>
               </div>
            </div>
         </div>
      </div>

   
   </body>    











 
   <script>

      (function(){ 

         const btnAndInputStyles = {

            base:`
            appearance: none;
            color: white;
            cursor: pointer;  
            position: relative;   
            display: inline-block;
            vertical-align: middle;
            width: var(--button-size);
            aspect-ratio: 1 / 1;
            max-height: 100%;
            background-color: rgb(255 255 255 / .1);
            border-radius: .2rem;
            outline: 0.1rem solid rgb(0 0 0 / .1); 
            box-shadow: rgb(0 0 0 / .4)       -1px -1px 1px 1px inset,
                        rgb(255 255 255 / .1)  1px  1px 1px 1px inset;`,
 
            active: `box-shadow: rgb(0 0 0 / .4)         1px  1px 1px 1px inset,
                     rgb(255 255 255 / .1)  -1px -1px 1px 1px inset; 
                     background-color: rgb(0 0 0 / .1);`,
            hover : `background-color: rgb(255 255 255 / .2);
         outline: 0.1rem solid rgb(0 0 0 / .2); 
         box-shadow: rgb(0 0 0 / .3)       -1px -1px 1px 1px inset,
                     rgb(255 255 255 / .2)  1px  1px 1px 1px inset; `
         }
     
         
         const IMG_FILE_EXTENSIONS = ['jpg','jpeg','png','gif','svg','heic','webp'];

         function setCssProp(prop, val) {
            requestAnimationFrame(()=> document.documentElement.style.setProperty(prop, val)) 
         }

         function readCssProp(prop) {
            return getComputedStyle(document.documentElement).getPropertyValue(prop)
         }

         function toggleAttr(el, attr, cond) {
            if ((cond !== undefined ? cond : !el.hasAttribute(attr)) === true) {
               el.setAttribute(attr,'')
            } else {
               el.removeAttribute(attr)
            }
         }
         
         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         // XY - a tiny class for simplifying coordinate based tuple math
         ////////////////////////////////////////////////////////////////////////////////////////////////////////

         const XY = (function(){

            const xYproto = Object.create( null, Object.getOwnPropertyDescriptors({
               toString()  { return `${this.x}, ${this.y}` },
               toArr()     { return [...this] },
               get x()     { return this.xy[0] },
               get y()     { return this.xy[1] }, 
               get sum()   { return this.xy[0] + this.xy[1] },
               get sqr()   { return powr(  this.xy, readXY(2) ) },    
               distTo(x,y) { return distTo(this.xy, readXY(x,y)) },
               powr(x,y)   { return powr(  this.xy, readXY(x,y)) },
               minus(x,y)  { return minus( this.xy, readXY(x,y)) },
               divd(x,y)   { return divd(  this.xy, readXY(x,y)) },
               min(x,y)    { return min(   this.xy, readXY(x,y)) },
               max(x,y)    { return max(   this.xy, readXY(x,y)) },
               * [Symbol.iterator]() {
                  yield this.xy[0]
                  yield this.xy[1]
                  return
               }
            })) 

            function isNum (Z)        { return (typeof Z == 'number' && Number.isFinite(Z)) } 
            function isNums(a,b)      { return (isNum(a) && isNum(b) ? [a,b] : undefined) }
            function distTo(xy1, xy2) { return (minus(xy1, xy2).sqr.sum)**0.5 }
            function powr  (xy1, xy2) { return XY(xy1[0]**xy2[0], xy1[1]**xy2[1]) }
            function divd  (xy1, xy2) { return XY(xy1[0]/ xy2[0], xy1[1]/ xy2[1]) } 
            function minus (xy1, xy2) { return XY(xy1[0]- xy2[0], xy1[1]- xy2[1]) }
            function min   (xy1, xy2) { return XY(Math.min(xy1[0], xy2[0]), Math.min(xy1[1], xy2[1])) }
            function max   (xy1, xy2) { return XY(Math.max(xy1[0], xy2[0]), Math.max(xy1[1], xy2[1])) }

            function readXY (a,b){ 
               return (isNums(a,b) ?? isNums(a,a) ?? isNums(a.x,a.y)
                    ?? isNums(a.offsetWidth, a.offsetHeight) ?? isNums(a.width, a.height)
                    ?? isNums(a[0],a[1]) ?? ([(a ?? NaN),(b ?? NaN)]))   
            }

            return function(x,y) {
               return Object.defineProperty( Object.create(xYproto), 'xy', {
                  value: Object.seal( readXY(x,y) ),
                  enumerable: true
               })
            }
         })()

         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         //
         ////////////////////////////////////////////////////////////////////////////////////////////////////////
           
         function rafThrottle(func, raf, data) {
            return function (...args) {
               data = [this, args];
               if (raf == null)
                  raf = requestAnimationFrame(()=> { func.apply(...data); raf = null; })
            }
         }

         function debounce(f, t=100, id) {
            return function(...args) {
               clearTimeout(id);
               id = setTimeout(()=> f.apply(this, args), t)
            }
         } 

         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         // for more elegant click + hold/move mouse behaviors
         ////////////////////////////////////////////////////////////////////////////////////////////////////////

         let onePointerIsDown = false;
         
         const trackPointer = (function(){

            let lastPtrUp = null

            const POINTER_TRACK_THRESHOLD = 6,
                  DBL_CLICK_MS = 278

            return function(event, options) {    
             
               if (onePointerIsDown === true || (event.pointerType === 'mouse' && event.button === 2)) {
                  return false   
               }

               const opts      = options.eventOptions ?? {},
                     target    = event.composedPath ? event.composedPath()[0] : event.target,  
                     budgeAmt  = options.budgeThreshold ?? POINTER_TRACK_THRESHOLD, 
                     interrupt = options.interruptWhen  ?? (()=>false) 
             
               let origin = options.origin ?? XY(event)
             
               if (options.origin !== undefined && !(Object.getOwnPropertyNames(options.origin).includes('distTo'))) {
                  origin = XY(origin)  
               }

               let budged  = false,
                   lastPos = { x: event.x, y: event.y }
               
               if (opts.pointerdown?.stopPropagation !== false && event.cancelable) {
                  try        { event.stopPropagation() }
                  catch(err) { console.warn(err) }
               }
               if (opts.pointerdown?.preventDefault  !== false && event.cancelable) {
                  try        { event.preventDefault() }
                  catch(err) { console.warn(err) }
               } 
               if (event.pointerType === 'mouse') { 
                  target.setPointerCapture(event.pointerId) 
               }       

               const rafThrottledTrack = rafThrottle((e) => {  
                  if (options.simple === true || budged === true) { 
                     if (options.simple === true || (options.simple !== true && !(interrupt(e) === true))) {
                        if (options.track !== undefined) {
                           options.track(e, { lastPos, origin })
                        }
                     }
                     else { options.onInterrupt(e) }
                  }
                  else if (budged !== true && origin.distTo(lastPos) > budgeAmt) {
                     ;[ budged, lastPtrUp ] = [ true, null ]; 
                  }  
               }) 

               const track =  e => {  
                  if (opts.pointermove?.preventDefault !== false) {
                     e.preventDefault()  
                  }
                  lastPos.x = e.x 
                  lastPos.y = e.y 
                  rafThrottledTrack(e) 
               }  

               const release = (e) => {      
                  if (lastPtrUp > 0 && (e.timeStamp - lastPtrUp) < DBL_CLICK_MS && budged !== true) { 
                     target.dispatchEvent(new Event('double-click', { composed: true, bubbles: false })) 
                     lastPtrUp = null   
                  } else {
                     lastPtrUp = e.timeStamp
                  }  
                  ;['pointerup', 'contextmenu'].forEach(type => 
                     target.removeEventListener(type, release)
                  )
                  target.removeEventListener('pointermove', track )   
                  if (options.release) {
                     options.release(e)  
                  }
                  onePointerIsDown = false;
               }     

               lastPtrUp = !!lastPtrUp ? lastPtrUp : null
               
               if (options.start) {
                  options.start(event) 
               }

               onePointerIsDown = true;
               ;['pointerup', 'contextmenu'].forEach(type => target.addEventListener(type, release))  
               target.addEventListener('pointermove', track) 
            }

         })()

         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         // saves some boilerplate for creating shadow DOM based custom elements
         ////////////////////////////////////////////////////////////////////////////////////////////////////////

         class ShadowComponent extends HTMLElement {

            constructor() {
               super()
               this.styleSheet = new CSSStyleSheet();             
               this.styleText = '';
               this.attachShadow({ mode: "open" }); 
               this.shadowRoot.adoptedStyleSheets.push(this.styleSheet) 
            } 
            get template() { 
               return this.templateEl?.innerHTML
            }
            set template(templateStr) {
               if (this.template == null) {
                  this.templateEl = document.createElement('template')
                  this.templateEl.innerHTML = templateStr;
                  this.shadowRoot.appendChild(this.templateEl.content.cloneNode(true))
               }      
            } 
            get styles() {
               return this.styleText
            }
            set styles(styleStr) {
               this.styleText = styleStr;
               this.styleSheet.replaceSync(styleStr)
            }
         }
     

         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         // same as above but for non shadowDOM custom elements
         ////////////////////////////////////////////////////////////////////////////////////////////////////////
      

         class SimpleComponent extends HTMLElement {

            static componentCount = 0;

            constructor() {
               super()           
               SimpleComponent.componentCount+=1;
            } 
            get template() { 
               return this.templateEl?.innerHTML
            }
            set template(templateStr) {
               if (this.template == null) {
                  this.templateEl = document.createElement('template')
                  this.templateEl.innerHTML = templateStr;
                  this.appendChild(this.templateEl.content.cloneNode(true))
               }      
            } 
         }


         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         //   the +/- UI component
         ////////////////////////////////////////////////////////////////////////////////////////////////////////

         customElements.define('value-incrementer', class extends ShadowComponent{ 
            constructor() {
               super();

               this.styles = ` 
                  :host {
                     position: relative; 
                     display: inline-block;
                  }

                  button {
                     border: none;
                     outline: none;
                     ${btnAndInputStyles.base}
                     padding:none;
                  }
                  button:hover {
                     ${btnAndInputStyles.hover}
                  }
                  button[active],
                  button:active {
                     border: none; outline: none;
                     ${btnAndInputStyles.active}
                  }
                   
                  button:first-child {
                     border-top-left-radius: 8px;
                     border-bottom-left-radius: 8px;
                     border-top-right-radius: 0px;
                     border-bottom-right-radius: 0px;
                  }

                  button:nth-child(2) {
                     border-top-right-radius: 8px;
                     border-bottom-right-radius: 8px;
                     border-top-left-radius: 0px;
                     border-bottom-left-radius: 0px;
                  }

                  button >  svg {
                     fill: currentcolor;
                     position: relative;
                     top: 1px;
                     transform: none;
                  }

                  button:active > svg { 
                     transform: translate(1px, 1px);
                  }

                  button >  svg > path {
                     fill: inherit;
                  }

                  .reset-button svg {
                     left: -1px;
                  }`;

               this.template = `<div>  
                     <button class="minus-button"  type="button">
                        <svg class="minus-button" viewBox="0 0 64 64">
                            <path d="M50,27L14,27C12,27 11,28 11,30L11,34C11,36 12,37 14,37L50,37C52,37 53,36 53,34L53,30C53,28 52,27 50,27Z"/>
                        </svg>
                     </button><button class="plus-button"  type="button">
                        <svg class="plus-button" viewBox="0 0 64 64">
                            <path d="M27,14L27,50C27,52 28,53 30,53L34,53C36,53 37,52 37,50L37,14C37,12 36,11 34,11L30,11C28,11 27,12 27,14Z"/>
                            <path d="M50,27L14,27C12,27 11,28 11,30L11,34C11,36 12,37 14,37L50,37C52,37 53,36 53,34L53,30C53,28 52,27 50,27Z"/>
                        </svg>  
                     </button>${this.hasAttribute('show-reset') ? ` 
                     <button style="margin-left: .2rem" class="reset-button"  type="button">
                           <svg class="reset-button" viewBox="0 0 32 32">
                              <path d="M9.2 14c1-4 4-7 8.3-7a9 9 0 0 1 0 18c-2.4 0-4.4-1-6-2.5l-3 3.5a14 14 0 0 0 9 3.5 13.5 13.5 0 0 0 0-27A13 13 0 0 0 4.6 14H0l7 8 7-8H9.2Z"/>
                           </svg> 
                        </button>` : ``}</div>`
            }
            connectedCallback() {
               const detail = { value: 0 }
               this.event = new CustomEvent('increment', { detail, bubbles: true, composed: true })
               this.shadowRoot.querySelectorAll('button').forEach(btnEl=> {
                  btnEl.addEventListener('click', e=> {
                     detail.value = btnEl.getAttribute('class').split('-')[0];
                     this.dispatchEvent(this.event);
                  })
               }) 
            }
         })

    
         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         // slider UI component with label and value display
         ////////////////////////////////////////////////////////////////////////////////////////////////////////
    

         customElements.define('range-input', class extends ShadowComponent{

            constructor() { super()
    

               this.min = Number(this.getAttribute('min') ?? 0)
               this.max = Number(this.getAttribute('max') ?? 100)
               this.step = Number(this.getAttribute('step') ?? 1)
               this.currentValue = Number(this.getAttribute('value') ?? 0)
               this.unit = this.getAttribute('unit') ?? ''
               this.originalValue = this.currentValue;

               this.styles = `
                  :host {
                     display: flex;
                     flex-flow: row nowrap;
                     width: 100%;
                  }
                  input {
                     flex: 1 1 auto;
                     width: 100%;
                  }
                  value-incrementer {
                     flex: 0 0 5.5rem;
                  }
               `;

               this.template =`
                  <input name="range-input"
                         type ="range" 
                         min  ="${this.min}"
                         max  ="${this.max}"
                         step ="${this.step}"
                         value="${this.currentValue}" /> 
                  <value-incrementer show-reset></value-incrementer>
               `; 
            } 

            

            connectedCallback() { 
    
               
               this.inputEl = this.shadowRoot.querySelector('input'); 

               const detail = { value: Number(this.getAttribute('value') ?? "0"), from: 'input' }

               this.event = new CustomEvent('range-change', { composed: true, bubbles: true, detail })
 
               this.setNewValue = function(val,from) { 
                  detail.value = val;
                  detail.from  = from;
                  this.currentValue = val;
                  this.inputEl.value = val; 
                  if (from!=='outside'){
                     this.dispatchEvent(this.event);   
                  }               
               }

               this.shadowRoot.querySelector('input').addEventListener('input', e => {  
                  this.setNewValue(Number(e.originalTarget?.value ?? e.target.value), 'input') 
               })

               this.shadowRoot.querySelector('value-incrementer').addEventListener('increment', e=> { 
                  if (e.detail.value === 'reset') {
                     this.setNewValue(this.originalValue, 'increment')
                  } else {
                     this.setNewValue(Math.max(this.min, Math.min(this.max, this.currentValue + (e.detail.value==='plus'? this.step : -this.step ))), 'increment')    
                  }               
               })
            } 
         })
    

         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         // a fancy checkbox
         ////////////////////////////////////////////////////////////////////////////////////////////////////////


         customElements.define('fancy-checkbox', class extends ShadowComponent {

            constructor() {
               super()

               this.styles = `

                  :host {
                     --size-fraction: calc(var(--button-size) / 16); 
                     display:        inline-flex;
                     vertical-align:      middle;
                     align-items:         center;
                     position:          relative;  
                     font:               inherit; 

                  }

                  input[type="checkbox"] {  
                     ${btnAndInputStyles.base}
                     margin: 0 0 0 0;   
                     width: var(--button-size);   
                  }  

                  input[type="checkbox"]:active,
                  input[type="checkbox"][active] {
                     ${btnAndInputStyles.active}
                  }

                  input[type="checkbox"]:hover {
                     ${btnAndInputStyles.hover}
                  }

                  :host([disabled]) {
                     pointer-events: none;
                     opacity: .6;
                  }

                  input[type="checkbox"]:not(:checked):not([disabled]) + svg.checkmark-graphic {
                     transform: scale(0);
                  }
                  input[type="checkbox"]:checked + svg.checkmark-graphic {
                     transform: scale(1);
                  }

                  svg.checkmark-graphic {
                     position: absolute; 
                     pointer-events: none;
                     left: var(--size-fraction);
                     top:  var(--size-fraction);  
                     height: calc(var(--button-size) - (var(--size-fraction) * 3));
                     width:  calc(var(--button-size) - (var(--size-fraction) * 3));
                     transition: 50ms transform linear; 
                     color: white;
                     transition: transform 60ms linear;
                     fill: currentcolor;
                     stroke-width: 2px;
                     stroke: currentcolor;
                  }`;

               this.template = `<input type="checkbox" name="fancy-checkbox-input"/>
                  <svg class="checkmark-graphic" viewBox="0 0 32 32">
                     <path d="M3 22c-1-1-.5-1.3 0-2l1-1c.5-.5 1.5-.5 2 0l5 4s1 1 2 0L26 2c.3-.5.5-.3 1 0l2 1c1 .5.5 1 0 2L14 30c-.5.5-1.5.5-2 0l-9-8Z"/>
                  </svg>`;
            }

            connectedCallback() { 
               const detail = { toggle: this.hasAttribute('checked') }
               if (this.hasAttribute('checked')){
                  this.shadowRoot.querySelector('input').checked = true;
                  //this.removeAttribute('checked')
               }
               this.event = new CustomEvent('toggle-check', { detail, bubbles: true, composed: true })
               this.shadowRoot.querySelector('input').addEventListener('click', e=> { 
                     detail.toggle = e.target.checked
                     toggleAttr(this, 'checked', detail.toggle)
                     this.dispatchEvent(this.event); 
               })
            }
         })



         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         // the kaleidoscope
         ////////////////////////////////////////////////////////////////////////////////////////////////////////
    
         customElements.define('hypno-tiler', (()=> {

               function createTileGroupMarkup(nTiles) { 
                  let tileGroupMarkup = `<div class="tile-group">`
                  for (let i=0; i < nTiles; i++) {
                     tileGroupMarkup += `<div class="tri"></div>`
                  }
                  tileGroupMarkup += `</div>`;
                  return tileGroupMarkup
               }
               function createTileColumnNode(nGroups) {  
                  const tmpl = document.createElement('template')
                  let txt = `<div class="tile-column">` 
                  for (let i=0; i < nGroups; i++) {
                     txt += createTileGroupMarkup(12)
                  } 
                  txt += '</div>'
                  tmpl.innerHTML = txt
                  return tmpl.content.cloneNode(true)
               }

               return class extends ShadowComponent {

                  static observedAttributes = ['num-rows','num-columns'] 
                  constructor() {
                     super()
                     this.styles = `  
                        :host {                         
                           display: block;
                           width: min-content;                     
                           margin: 0 auto;
                           white-space: nowrap; 
                           transform-origin: center center;

                            -webkit-backface-visibility: hidden;
                              -webkit-perspective: 1000;
                              -webkit-transform: translate3d(0,0,0);
                              -webkit-transform: translateZ(0);
                              
                              perspective: 1000;
                              transform: translate3d(0,0,0);
                              transform: translateZ(0); 
                              backface-visibility: hidden;
                        }  

                        :host([reflect="6"]),
                        :host([reflect="12"]) {
                           --hex-width:      calc(var(--tile-width) * calc(4 / 3));
                           --hex-halfheight: calc(calc(var(--hex-width) * cos(30deg)) / 2) ;
                           --tri-size:       calc(var(--tile-width) * calc(2 / 3));
                        }
                       
                        :host([reflect="4"]),
                        :host([reflect="8"]) {
                           --tri-size: calc(var(--tile-width) / 2);
                        }

                        .tile-column {  
                           display: inline-block;
                           position: relative;
                        }  

                        .tile-group {
                           transform: rotateZ(0);   
                           width: var(--tile-width) ;
                        }  
                        
                        .tri {
                           height: var(--tri-size);
                           width: var(--tri-size); 
                           position: absolute;  
                           z-index:1;
                        }  

                        .tri:before {
                           z-index:-1;
                           content: "";
                           position: absolute;  
                           height: calc(var(--tri-size) + 50%);
                           width:  calc(var(--tri-size) + 50%); 
                           top: -25%;
                           left: -25%;  
                           background:          var(--image-url);   
                           background-position: var(--image-position); 
                           background-size:        var(--image-scale);
                           transform:           var(--image-rotation); 
                        } 
                         
                       :host([reflect="4"]) .tile-group {     
                           width: var(--tile-width);
                           height: var(--tile-width);   
                        }

                       :host([reflect="4"]) .tri {  
                           transform-origin: bottom right; 
                           clip-path: polygon(
                              -0.5px -0.5px,
                              -0.5px calc(100% + 0.5px),
                              calc(100% + 0.5px) calc(100% + 0.5px),
                              calc(100% + 0.5px) -0.5px
                           );
                        }  

                       :host([reflect="4"]) .tri:nth-child(1)  { }
                       :host([reflect="4"]) .tri:nth-child(2)  {  transform: scaleY(-1);  }
                       :host([reflect="4"]) .tri:nth-child(3)  {  transform: scaleX(-1) scaleY(-1); }
                       :host([reflect="4"]) .tri:nth-child(4)  {  transform: scaleX(-1);  }
                       :host([reflect="4"]) .tri:nth-child(5),
                       :host([reflect="4"]) .tri:nth-child(6),
                       :host([reflect="4"]) .tri:nth-child(7),
                       :host([reflect="4"]) .tri:nth-child(8),
                       :host([reflect="4"]) .tri:nth-child(9),
                       :host([reflect="4"]) .tri:nth-child(10),
                       :host([reflect="4"]) .tri:nth-child(11),
                       :host([reflect="4"]) .tri:nth-child(12) { 
                           display: none;
                        }
                     

           
                         
                       :host([reflect="6"]) .tile-column:nth-child(even) {  
                           top: calc(calc(var(--hex-halfheight) * -1));  
                        }  

                       :host([reflect="6"]) .tile-group {   
                           height:      var(--hex-halfheight);  
                           padding-top: var(--hex-halfheight);
                        }

                       :host([reflect="6"]) .tri {  
                           transform-origin: top center;
                           clip-path: polygon(
                              calc(50% + .5px) 0,
                              calc(50% - .5px) 0,
                              0px 86%,
                              0px calc(86.6% + 1px),
                              100% calc(86.6% + 1px),
                              100% 86%
                           );  
                        }  

                       :host([reflect="6"]) .tri:nth-child(1) { }
                       :host([reflect="6"]) .tri:nth-child(2) {  transform: rotate(60deg) scaleX(-1);  }
                       :host([reflect="6"]) .tri:nth-child(3) {  transform: rotate(120deg); }
                       :host([reflect="6"]) .tri:nth-child(4) {  transform: rotate(180deg) scaleX(-1); }
                       :host([reflect="6"]) .tri:nth-child(5) {  transform: rotate(240deg); }
                       :host([reflect="6"]) .tri:nth-child(6) {  transform: rotate(-60deg) scaleX(-1); } 
                       :host([reflect="6"]) .tri:nth-child(7),
                       :host([reflect="6"]) .tri:nth-child(8),
                       :host([reflect="6"]) .tri:nth-child(9),
                       :host([reflect="6"]) .tri:nth-child(10),
                       :host([reflect="6"]) .tri:nth-child(11),
                       :host([reflect="6"]) .tri:nth-child(12) {
                           display: none;
                        } 
                   
                         
                      

                       :host([reflect="8"]) .tile-group {    
                           height: var(--tile-width);   
                        }

                       :host([reflect="8"]) .tri {  
                           transform-origin: bottom right;
                           clip-path: polygon(
                              -0.5px -0.5px,
                              calc(100% + 0.5px) -0.5px,
                              calc(100% + 0.5px) calc(100% + 0.5px),
                              calc(100% - 0.5px) calc(100% + 0.5px),
                              -0.5px 0
                           ); 
                        } 

                       :host([reflect="8"]) .tri:nth-child(1) { }
                       :host([reflect="8"]) .tri:nth-child(2) { transform: translateX(0%) scaleX(-1); }
                       :host([reflect="8"]) .tri:nth-child(3) { transform: rotate(180deg); }
                       :host([reflect="8"]) .tri:nth-child(4) { transform: rotate(180deg) scaleX(-1); }
                       :host([reflect="8"]) .tri:nth-child(5) { transform: rotate(270deg)  ;}
                       :host([reflect="8"]) .tri:nth-child(6) { transform: rotate(270deg) scaleX(-1); }
                       :host([reflect="8"]) .tri:nth-child(7) { transform: rotate(90deg); } 
                       :host([reflect="8"]) .tri:nth-child(8) { transform: rotate(90deg) scaleX(-1); } 
                       :host([reflect="8"]) .tri:nth-child(9), 
                       :host([reflect="8"]) .tri:nth-child(10),
                       :host([reflect="8"]) .tri:nth-child(11),
                       :host([reflect="8"]) .tri:nth-child(12) {
                           display: none;
                        } 
                      

                       :host([reflect="12"]) .tile-column:nth-child(even) {  
                           top: calc(var(--hex-halfheight) * -1);  
                        }  

                       :host([reflect="12"]) .tile-group {   
                           height:      var(--hex-halfheight);  
                           padding-top: var(--hex-halfheight);
                        }

                       :host([reflect="12"]) .tri {  
                           width: calc(var(--tri-size) / 2);
                           transform-origin: top right; 
                           clip-path: polygon(
                              calc(100% + 0.5px) 0,
                              calc(100% + 0.5px) calc(86.6% + 0.5px),
                              -0.5px calc(86.6% + 0.5px),
                              -0.5px 86.6%, 
                              calc(100% - 0.5px) 0
                           );  
                        }  

                       :host([reflect="12"]) .tri:nth-child(1)  { }
                       :host([reflect="12"]) .tri:nth-child(2)  {  transform: scaleX(-1); }
                       :host([reflect="12"]) .tri:nth-child(3)  {  transform: rotate(60deg) scaleX(-1); }
                       :host([reflect="12"]) .tri:nth-child(4)  {  transform: rotate(-60deg); }
                       :host([reflect="12"]) .tri:nth-child(5)  {  transform: rotate(60deg); } 
                       :host([reflect="12"]) .tri:nth-child(6)  {  transform: scaleX(-1) rotate(60deg); } 
                       :host([reflect="12"]) .tri:nth-child(8)  {  transform: scaleY(-1); } 
                       :host([reflect="12"]) .tri:nth-child(7)  {  transform: scaleY(-1) scaleX(-1); } 
                       :host([reflect="12"]) .tri:nth-child(9)  {  transform: scaleY(-1) rotate(60deg); } 
                       :host([reflect="12"]) .tri:nth-child(10) {  transform: scaleY(-1) rotate(60deg) scaleX(-1);  } 
                       :host([reflect="12"]) .tri:nth-child(11) {  transform: scaleY(-1) rotate(-60deg);  } 
                       :host([reflect="12"]) .tri:nth-child(12) {  transform: scaleY(-1) rotate(-60deg) scaleX(-1); } 
                        `;

                     this.template = ``;
                  }
                  connectedCallback() {   
                     for (let i=0; i<((window.innerWidth / 240)+3); i++) {
                       this.shadowRoot.appendChild(createTileColumnNode(((window.innerHeight / 240)+3)))
                     }   
                     this.setAttribute('num-columns', this.shadowRoot.children.length)
                     this.setAttribute('num-rows', this.shadowRoot.children[0].children.length)
                  }
                  createTileGroup() {
                     const tmpl = document.createElement('template')
                     tmpl.innerHTML = createTileGroupMarkup(12)
                     return tmpl.content.cloneNode(true)
                  }

                  getNumRows() {
                     return [...this.shadowRoot.querySelector('.tile-column').children].length
                  }

                  getNumCols() {
                     return [...this.shadowRoot.querySelectorAll('.tile-column')].length
                  }

                  setRowOrCol(rowOrCol, num) {
                     if (rowOrCol==='row') {
                        this.setNumRows(num)
                        this.setAttribute('num-rows', num)
                     }
                     else if (rowOrCol==='column') {
                        this.setNumCols(num)
                        this.setAttribute('num-columns', num)
                     }
                  }

                  setNumRows(rowNum) {
                     const curr = this.getNumRows()
                     if (rowNum < curr) {
                        [...this.shadowRoot.querySelectorAll('.tile-column')].forEach(col=> {
                           [...col.children].at(-1).remove()
                        });
                     } else if (rowNum > curr) {
                        [...this.shadowRoot.querySelectorAll('.tile-column')].forEach(col=> {
                           col.appendChild(this.createTileGroup())
                        }) 
                     }
                  }

                  setNumCols(colNum) {
                     const curr = this.getNumCols()
                     if (colNum < curr) {
                        [...this.shadowRoot.querySelectorAll('.tile-column')].at(-1).remove()
                     } else if (colNum > curr) {
                        this.shadowRoot.appendChild(createTileColumnNode(this.getNumRows()))
                     }
                  } 
               }

            })())
    
    
         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         // image upload / preview / drag+drop box
         ////////////////////////////////////////////////////////////////////////////////////////////////////////
    

            customElements.define('image-uploader', (()=> {

               async function ifUrlExist(url) {
                  return new Promise((resolve, reject) => { 
                     fetch(url, { method: "HEAD"}).then(response => {
                        resolve(response.status.toString()[0] === "2")
                        }).catch(error => { reject(false) }) 
                  })
               }

               return class extends ShadowComponent{
                  constructor() { super();
                     this.styles = `  

                        :host,
                        input[type="url"],
                        input[type="file"] {
                           position: relative;
                           width: 100%;
                        }

                        :host {            
                           display: block;
                           text-align: center; 
                           flex: 0 0 auto; 
                           border-radius: 8px;  
                           margin: 0 auto;     
                           
                           cursor: pointer;
                           z-index: 1;  
                        }  
  
                        input[type="file"]{ 
                           margin: 0 auto;
                           box-sizing: border-box; 
                           appearance: none; 
                           width: 75%;
                        } 

                        .image-frame {
                           position: absolute;
                           height: 100%;
                           width: 100%;
                           border-radius: 8px; 
                           overflow: hidden;
                           text-align: center; 
                        }
                        .image-frame-center {
                           display: grid;
                           width: 100%;
                           place-content: center;
                        }
                        img#preview-image-element {   
                           align-self: center;
                           justify-self: center;
                           max-height: 200px;
                           margin: 0 auto;
                           height: 100%; 
                           width: auto; 
                           position: relative;
                           object-fit: contain;
                           box-sizing: border-box; 
                           content: var(--image-url);      
                           z-index:0;
                           pointer-events: none;
                        }

                        :host(.drag-ready:not(.selecting))  {
                              outline: 2px dashed rgb(255 255 255 / .8);
                        }
                        .image-upload-area { 
                           height: 200px;
                           max-width: 100%;
                           position: relative;
                           max-height: 200px;
                           outline:  2px dashed rgb(255 255 255 / .8);
                           visibility: hidden;
                           display: grid;
                             border-radius: 8px; 
                           background: rgb(0 0 0 / .5);
                           place-content: center;
                        }

                        :host(.drag-ready) .image-upload-area {
                           background:  green;
                           filter: brightness(120%);
                        }

                        :host(.selecting) .image-upload-area {
                           visibility: visible;
                        }

                        .image-upload-area span {
                           color: white;
                        }
 
                        .sub-text {
                           opacity :0.8;
                           font-size: 75%;
                        }

                        .svg-wrap {
                           max-width: 100%;
                           line-height: 30px;
                        }

                        .svg-wrap svg {
                           max-width: 40px;
                           height: 100%;
                           fill: white;
                           display: inline-block;
                           vertical-align: middle;
                        }

                        .main-text {
                           font-weight: bold; 
                        }
                        :host(.url-input) .add-image-icon,
                        :host(.url-input) .image,
                        :host(:not(.url-input)) .url,
                        :host(.selecting) .image-frame,
                        input[type="url"],
                        :host(:not(.url-input)) .link-icon
                         {
                           display: none;
                        } 
                       :host(.url-input) .main-text.url,
                       :host(.url-input) input[type="url"],
                       :host(.url-input) .link-icon {
                           display: initial;
                        }  

                        .url-wrap {
                           display: flex;
                           flex-flow: row nowrap;
                        }
                        .url-wrap input {
                           flex: 1 1 auto;
                        }
                        .url-wrap button {
                           flex: 0 0 2rem;
                        }
                        #close-button, #image-url-button {
                           width: 32px;
                           position: absolute;  
                        }
                        #close-button { 
                           top: 1px;
                           right: 1px;
                        }
                        #image-url-button {
                           top: 1px;
                           left: 1px;
                        }
                        #close-button svg,
                        #image-url-button svg {
                           width: 20px;                           
                           fill: white;
                        }
                        #close-button svg,
                        #image-url-button svg {
                           position:relative;
                           top: 2px;
                        }
                        .sub-text.url {
                           font-weight:bold;
                        }
                        #close-button svg.icon rect:first-child {
                           transform-origin:center center;
                           transform: rotate(45deg);
                        }
                        #close-button svg.icon rect:nth-child(2) {
                           transform-origin:center center;
                           transform: rotate(-45deg);
                        }

                        .shadow-draw { 
                           position: absolute;
                           pointer-events: none;
                           width: 100%;
                           height: 100%; 
                           border-radius: 8px;
                           outline: 0.1rem solid rgb(0 0 0 / .1); 
                           box-shadow: rgb(0 0 0 / .4)       0px 0px 1px 1px inset;      
                        }
                        `;

                     this.template =  ` 
                        
                        <div class="image-frame">
                           <div class="image-frame-center">
                              <img id="preview-image-element" class="preview-image" > 
                           </div>
                        </div>
                        <div class="shadow-draw"></div>
                        <div class="image-upload-area">
                          <div id="close-button">
                              <svg class="icon"
                                   viewBox="0 0 30 26"
                                   xmlns="http://www.w3.org/2000/svg"
                                   preserveAspectRatio="xMidYMid meet"> 
                                  <rect class="menu-piece middle" x="1" y="11" width="28" height="4" rx="2" ry="2"/>
                                  <rect class="menu-piece bottom" x="1" y="11" width="28" height="4" rx="2" ry="2"/>
                              </svg>
                           </div> 
                           <div class="image" id="image-url-button">
                              <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2" viewBox="0 0 109 109"><path d="M56 34s-5-3-16 0l20-20a25 25 0 0 1 35 35L80 65a25 25 0 0 1-36 0 6 6 0 0 1 8-9c6 6 14 6 20 0l15-15a14 14 0 0 0-19-19L56 34Zm-3 41s5 3 16 0L49 95a25 25 0 0 1-35-35l15-16c10-10 26-10 36 0a6 6 0 0 1-9 8c-5-5-14-5-19 0L22 68a14 14 0 0 0 19 19l12-12Z"/></svg>
                           </div>
                           <div class="svg-wrap">
                              <svg class="link-icon" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2" viewBox="0 0 109 109"><path d="M56 34s-5-3-16 0l20-20a25 25 0 0 1 35 35L80 65a25 25 0 0 1-36 0 6 6 0 0 1 8-9c6 6 14 6 20 0l15-15a14 14 0 0 0-19-19L56 34Zm-3 41s5 3 16 0L49 95a25 25 0 0 1-35-35l15-16c10-10 26-10 36 0a6 6 0 0 1-9 8c-5-5-14-5-19 0L22 68a14 14 0 0 0 19 19l12-12Z"/></svg>
                              <svg class="add-image-icon" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 120 120">
                                 <path d="M77 111H25A16 16 0 0 1 9 95V25A16 16 0 0 1 25 9h70a16 16 0 0 1 16 16v52a24 24 0 0 0-2-1.7V25a14 14 0 0 0-14-14H25a14 14 0 0 0-14 14v62l20-19 20 17 27-29 10.5 14.6A24 24 0 0 0 77.1 111Z"/>
                                 <circle cx="38" cy="36" r="13"/>
                                 <path d="M94 72.6a21.4 21.4 0 1 1 0 42.8 21.4 21.4 0 0 1 0-42.8Zm-2.5 23.9v6.5c0 .8.7 1.5 1.5 1.5h2c.8 0 1.5-.7 1.5-1.5v-6.5h6.5c.8 0 1.5-.7 1.5-1.5v-2c0-.8-.7-1.5-1.5-1.5h-6.5V85c0-.8-.7-1.5-1.5-1.5h-2c-.8 0-1.5.7-1.5 1.5v6.5H85c-.8 0-1.5.7-1.5 1.5v2c0 .8.7 1.5 1.5 1.5h6.5Z"/>
                              </svg> 
                           </div>
                           <span class="image main-text">Drop images here</span>
                           <span class="url main-text">Load Remote Image</span>
                           <span class="sub-text">Files supported: JPG, PNG, GIF, SVG</span>
                           <span class="image">OR</span> 
                           <span class="sub-text url">Enter image url below</span> 
                           <input class="image" title=" " type="file" id="file-input-element" name="file" accept="image/*" /> 
                           <div class="url url-wrap">
                              <input type="url" id="url-input-element"/>
                              <button title="Load Image Url" type="button" id="url-input-submit">Load</button>
                           </div>
                        </div>`; 
                  }

             

                  async submitUrl(url) {
                     //console.log(url)
                     const  extens  = url.split('.').at(-1) 
                        if (url.startsWith('http') && extens && IMG_FILE_EXTENSIONS.includes(extens)) { 
                           try {
                              const urlValid = await ifUrlExist(url)
                              if (urlValid) {
                                 this.selecting = false; 
                                 setCssProp('--image-url', 'url('+url+')')  
                              }
                           }
                           catch(error) {
                              console.log('error caught')
                           } 
                        } 
                  }

                  connectedCallback() {
 
                     this.fileInputEl = this.shadowRoot.querySelector('#file-input-element') 
                      this.urlInputEl  = this.shadowRoot.querySelector('#url-input-element') 
  
                     this.shadowRoot.querySelector('.image-frame').addEventListener('click',e=> {
                        this.classList.remove('url-input')
                        this.classList.add('selecting')
                     })
                     this.shadowRoot.querySelector('#close-button').addEventListener('click', e=> { 
                        e.stopPropagation()
                        this.classList.remove('selecting')  
                     })

                     this.fileInputEl.addEventListener('change', async e => { 
                        const file = this.fileInputEl.files[0]
                        if (IMG_FILE_EXTENSIONS.includes(file.name.split('.').at(1))) { 
                           let url=URL.createObjectURL(file)
                           this.classList.remove('selecting')
                           setCssProp('--image-url', 'url('+url+')');  
                        }
                     })                     

                     this.shadowRoot.querySelector('#image-url-button').addEventListener('click',e=> {
                        if ( !this.classList.contains('url-input')) {
                           this.classList.add('selecting')

                           this.classList.add('url-input')
                        } else if (this.classList.contains('url-input')) {
                           this.classList.remove('selecting')
                           this.classList.remove('url-input');
                           this.classList.remove('drag-ready')
                        }
                     })

                     this.shadowRoot.querySelector('#url-input-submit').addEventListener('click',  e=> {  
                       this.submitUrl(this.urlInputEl.value);
                     }) 
                     
                     
                     this.addEventListener('dragover', e=> { 
                        e.preventDefault()
                     })

                     this.addEventListener('dragenter', e=> {
                         e.preventDefault() 
                        this.classList.add('drag-ready')  
                     }) 
                      this.addEventListener('dragleave', e=> {
                         e.preventDefault() 
                        this.classList.remove('drag-ready')  
                     }) 

                     this.addEventListener('drop', e=> {   
                        e.preventDefault();    
                        [...e.dataTransfer.items] 
                           .filter( x => x.kind === 'file')
                           .forEach( async blob => {   
                              const file = await blob.getAsFile()                                
                              if (IMG_FILE_EXTENSIONS.includes(file.name.split('.').at(-1))) { 
                                 setCssProp('--image-url', 'url('+URL.createObjectURL(file)+')') 
                                 this.classList.remove('selecting')                                 
                              }
                              this.classList.remove('drag-ready')
                           })  
                     })  
                  }
               } 
            })())
       


         ////////////////////////////////////////////////////////////////////////////////////////////////////////
         //  
         ////////////////////////////////////////////////////////////////////////////////////////////////////////


         ;(function(){

            const SNAP_TOLERANCE = 80,
                  origWidth      = 300, 
                  MINMAINWIDTH   = 210, 
                  dashEl         = document.getElementById('dash'), 
                  innerDashEl    = document.getElementById('inner-dash'), 
                  animLim        = { r: 3100, x: 3400, y: 2870, z: 100 },
                  incr           = { r: 0, x: 1, y: 0, z: 0 },
                  TIME_INTERVALS = [
                     4000, 7000, 10000, 15000, 25000
                  ],
                  hypno = document.querySelector('hypno-tiler'),
                  upl = document.querySelector('image-uploader'),
                  ANIM_SELECT_PROBABILITIES = [
                     'x','x','x','x','x','x','x',
                     'y','y','y','y','y','y','y',
                     'r','r','r','r'
                  ];

            let dashMin, 
                pollingRate = 15,
                intervalId,
                autoModeInterval, 
                activeAnimations = [],
                aniPause = false;

            function startDashMove(event) {
              
               document.body.classList.add('no-transitions'); 

               const tol     = SNAP_TOLERANCE,
                     screen  = { x: window.innerWidth, y: window.innerHeight },
                     mainmin = screen.x, 
                     offset  = event.x - getDashWidth();
             
               trackPointer(event,  {  
                  budgeThreshold: 0,  
                  track: evt => {      
                     const xPos = evt.x - offset 
                     if (xPos < screen.x && xPos >= 0 && xPos !== getDashWidth()) {
                        setDashWidth(xPos)
                        setInnerDashTranslate(Math.max(dashMin*-1, Math.min( 0, xPos-dashMin))) 
                        toggleAttr(document.body, 'dash-open', xPos > 0) ;  
                     } 
                  }, 
                  release: (event) => {        
                     const dx = getDashWidth() 
                     document.body.classList.remove('no-transitions')    
                     if (dx > (screen.x - tol/1.5)) { 
                        setDashWidth(screen.x)
                     }
                     else { 
                        if      (dx > mainmin)       { setDashWidth(mainmin) }
                        else if (dx < dashMin - tol) { requestAnimationFrame(()=> toggleDash('close')) }
                        else if (dx < dashMin + tol) { requestAnimationFrame(()=> toggleDash('open')) } 
                     }   
                  }
               });  
            }
             
            function startImageMove(event) {

               let shouldRestart = false;

               document.body.classList.add('no-transitions'); 

               const activeTool = document.body.getAttribute('active-tool')
               const origClick   = [ Math.round(event.x), Math.round(event.y) ];

               let startingPos, changeFunc;

               const zoomFraction = 1 / (Number(readCssProp('--zoom-amount').replace('%','')) / 100);

               if (activeTool === 'move') { 
                  startingPos = readCssProp('--image-position').replace(/px/g,'').split(' ').map(Number);
                  changeFunc = (e)=> {
                     setCssProp('--image-position', 
                        (startingPos[0] + (Math.round(e.x - origClick[0]) * zoomFraction)) + 'px ' +
                        (startingPos[1] + (Math.round(e.y - origClick[1]) * zoomFraction)) + 'px'
                     )
                  }
               }
               else if (activeTool === 'twist') { 
                  startingPos = Number(readCssProp('--image-rotation').replace(/[^0-9]/g,'')) 
                  changeFunc = (e)=> {
                     setCssProp('--image-rotation', 'rotate('+(startingPos + Math.round(e.y - origClick[1])) + 'deg)')
                  }
               } 
               else if (activeTool === 'pan') {  
                  startingPos = [ Number(readCssProp('--pan-x').replace('px','')), Number(readCssProp('--pan-y').replace('px',''))];
                  changeFunc = (e)=> {
                     setCssProp('--pan-x',(startingPos[0]+(  Math.round(e.x - origClick[0])*zoomFraction)) + 'px')
                     setCssProp('--pan-y',(startingPos[1]+(  Math.round(e.y - origClick[1])*zoomFraction)) + 'px') 
                  }
               }
         
               trackPointer(event,  {  
                  budgeThreshold: 0,  
                  start: evt =>{
                     if (intervalId != null) {
                        stopAnimation()
                        shouldRestart = true;
                     } 
                  },
                  track: changeFunc, 
                  release: () => {       
                     document.body.classList.remove('no-transitions') 
                     if (shouldRestart == true) {
                        startAnimation()
                     }
                  }
               }); 
            }

            function toggleDash(state) { 

               toggleAttr(document.body, 'dash-open', state=='open');  

               if (state == 'open') {
                  setDashWidth(dashMin)
                  setInnerDashTranslate(0)
               } else {
                  setDashWidth(0)
                  setInnerDashTranslate(dashMin * -1)
               } 
            }

            function setInnerDashTranslate(translateAmt) {
               innerDashEl.style.transform = 'translateX(' + translateAmt + 'px)'
            }

            function setDashMin(amt) {
               dashMin = amt;
               innerDashEl.style.minWidth = dashMin + 'px'
            }

            function getDashWidth() {
               return Number(dashEl.style.width.replace('px',''))
            }

            function setDashWidth(amt) {
               dashEl.style.width = amt + 'px'
            } 

            const anVal = document.getElementById('animate-value-display');
            function toggleAnimationProp(property) { 
               if (property==='rotate') {
                  property = 'r'
               } 
               if (!activeAnimations.includes(property)){ 
                  if (activeAnimations.length === 0){ startAnimation() }
                  activeAnimations.push(property) 
               } 
               else { 
                  activeAnimations = activeAnimations.filter(itm => itm!==property) 
                  if (activeAnimations.length === 0) { stopAnimation()  }
               }  

            }

            //const zoomSlider = document.getElementById('zoom-input-slider');
    
            function startAnimation(param) {   
               if (intervalId == null) {  
                  const changeFunc = ()=> {  
                     const [x,y] = readCssProp('--image-position').replace(/px/g,'').split(' ').map(Number), 
                           pos   = { x, y, r: Number(readCssProp('--image-rotation').replace(/[^\-0-9]/g,''))}; 
                     ['x','y','r'].forEach(prop => {
                        if (activeAnimations.includes(prop)) {
                           let incrBase = prop === 'r' ? 0.8 : 1;
                           if (incr[prop] === 0 || pos[prop] <= -animLim[prop])  { incr[prop]=incrBase }
                           if (pos[prop] >= animLim[prop]) { incr[prop] = incrBase*(-1) }
                        }
                        else { incr[prop]= 0; }
                     });
                     if (!(incr.x === 0 && incr.y ===0)) {
                        setCssProp('--image-position', (x + incr.x)+'px '+(y + incr.y)+'px')     
                     }               
                     if (incr.r !== 0) {
                        setCssProp('--image-rotation', 'rotate('+(Math.round((pos.r + incr.r)*10)/10) + 'deg)') 
                     } 
                     intervalId = setTimeout(()=> changeFunc(), pollingRate);   
                  }  
                  intervalId = setTimeout(()=> changeFunc(), pollingRate);  
               } 
            }

            function stopAnimation(param) { 
               clearInterval(intervalId);
               intervalId = null; 
            } 
            
            const enableAutoMode = (()=> {
               
               const getRandInterval = (arr)=> arr[arr.length * Math.random() | 0];

               return function() {
 
                  document.querySelector('.animate-properties-group').classList.add('automode-enabled');
                  ['animate-x-toggle','animate-y-toggle','animate-rotate-toggle'].forEach(id=>{
                     document.getElementById(id).setAttribute('disabled','')
                  });
                  const change = ()=> { 
                     const randVal = Math.round(Math.random()*2)
                     switch(activeAnimations.length) {
                        case 0:
                           toggleAnimationProp(getRandInterval(ANIM_SELECT_PROBABILITIES))
                           break;
                        case 1:  
                           let toAddFrom = ANIM_SELECT_PROBABILITIES.filter(item=> item !== activeAnimations[0])
                           if (randVal===0){ 
                              toggleAnimationProp(getRandInterval(toAddFrom))
                           } else if (randVal===1) {
                              let curr = activeAnimations[0]; 
                              toggleAnimationProp(getRandInterval(toAddFrom))
                              toggleAnimationProp(curr)
                           } 
                           break;
                        case 2:  
                           if (randVal===0) {
                              toggleAnimationProp(activeAnimations.includes('r') ? 'r': getRandInterval(activeAnimations))
                           } else if (randVal===1) {
                              let toAddFrom = ANIM_SELECT_PROBABILITIES.filter(item=> !activeAnimations.includes(item))
                              toggleAnimationProp(getRandInterval(toAddFrom))
                           } 
                           break;
                        case 3: 
                           if (randVal!==3){
                              toggleAnimationProp(activeAnimations.includes('r') ? 'r': getRandInterval(activeAnimations))    
                           }              
                           break;
                     }
                     autoModeInterval = setTimeout(change,  getRandInterval(TIME_INTERVALS))
                  } 
                  if (autoModeInterval==null){
                     change()
                  }
               }
            })()

            function disableAutoMode() {
               let checkedAnims = []; 
               document.querySelector('.animate-properties-group').classList.remove('automode-enabled');
               ['animate-x-toggle','animate-y-toggle','animate-rotate-toggle'].forEach(id=>{
                  const el = document.getElementById(id)
                  if (el.hasAttribute('checked')) {
                     checkedAnims.push(((id.split('-')[1])[0]))
                  }
                  el.removeAttribute('disabled')
               }); 
               checkedAnims.forEach(anim=>{
                  if (!activeAnimations.includes(anim)) toggleAnimationProp(anim) }) 
               activeAnimations.forEach(anim=>{
                  if (!checkedAnims.includes(anim)) toggleAnimationProp(anim) }) 
               clearTimeout(autoModeInterval)
               autoModeInterval = null; 
            }

 
            function activateTool(tool) {
               if (tool !== document.body.getAttribute('active-tool')) {  
                  document.body.setAttribute('active-tool', tool) 
               }
            }
     
            document.getElementById('menu-button').addEventListener('click', e=> {
               toggleDash(getDashWidth() > 0 ? 'close' : 'open')
            }) 

            document.getElementById('dash-handle').addEventListener('pointerdown', e=> {
               if (e.target.tagName === 'DIV') { startDashMove(e) }
            }) 

            document.getElementById('main').addEventListener('pointerdown', e=> {
               startImageMove(e)
            })    

            document.getElementById('main').addEventListener('dragenter', e=> {
               e.preventDefault()
            }) 
            document.getElementById('main').addEventListener('dragover', e=> e.preventDefault())
            document.getElementById('main').addEventListener('drop', e=> {   
               e.preventDefault();    
               [...e.dataTransfer.items] 
                  .filter( x => x.kind === 'file')
                  .forEach( async blob => {   
                     const file = await blob.getAsFile()                                
                     if (IMG_FILE_EXTENSIONS.includes(file.name.split('.').at(-1))) { 
                        setCssProp('--image-url', 'url('+URL.createObjectURL(file)+')') 
                        upl.classList.remove('selecting')
                        upl.classList.remove('url-input')
                     }
                  })  
            }) 

            const reflectVal = document.getElementById('reflect-value-display');
            const updateReflect = ()=>{
               for(let inp of [...document.querySelectorAll('#mirror-radio-select input')]){
                  if (inp.checked){
                     reflectVal.innerHTML =inp.value;
                     break;
                  }
               }
            }

            
            
            
            document.getElementById('mirror-radio-select').addEventListener('click', e=> {
               let val = Number(e.originalTarget?.value ?? e.target.value)
               if ([4,6,8,12].includes(val)) {
                  document.querySelector('hypno-tiler').setAttribute('reflect', val)    
               } 
               updateReflect()
            });
            updateReflect()
            

            document.querySelectorAll('div.image-control-group .display-section').forEach(group=>{
               group.addEventListener('click',function(e){
                  [...this.parentNode.parentNode.children].forEach(child=> {
                     if (child!==this.parentNode) {
                        child.removeAttribute('active')
                     } else {
                        toggleAttr(child, 'active')
                     }
                  })
               })
            })
    
            document.getElementById('canvas-tools-toolbar').addEventListener('click', e=> {
               const properTarget = (e.originalTarget ?? e.target)
               const tName = properTarget.getAttribute('tool-name').toLowerCase()
               if (tName){
                  properTarget.setAttribute('active','');

                  [...properTarget.parentNode.children].forEach(child=>{
                     if (child!==properTarget) { child.removeAttribute('active') }
                  }) 
                  activateTool(tName) 
               } 
            })
 
            const bouncedResizeTimer = debounce(()=> {
               document.body.classList.remove('window-resizing');   
               if (getDashWidth() > document.body.offsetWidth && document.body.hasAttribute('dash-open')) {
                  toggleDash('close') 
               }   
            }, 260)

            window.addEventListener('resize', e=> { 
               document.body.classList.add('window-resizing');
               if (  (dashMin != null)
                  && (dashMin > 50)
                  && (dashMin >= document.body.offsetWidth)) {
                  setDashMin(document.body.offsetWidth )
                  this.shrunkFrom    = true
               }
               else if (this.shrunkFrom===true && this.offsetWidth > dashMin)  {
                  setDashMin(origWidth )
               }
               bouncedResizeTimer();
            })

            function updateAnimDisplay() {
               let val = [];
               for (let checkbox of [...document.querySelectorAll('fancy-checkbox')]) {
                  const id = checkbox.id.split('-').at(1)
                  if (checkbox.hasAttribute('checked')) {
                     val.push(id[0].toUpperCase() + id.substring(1,id.length));
                  }
               }
               if (val.includes('Auto')) 
                  val = ['Auto']              
               if (val.length===0) 
                  val.push('None')              
               anVal.innerHTML = val.join(', '); 
            }
    
            ;['x','y','rotate'].forEach(toggle=> {
               document.getElementById('animate-'+toggle+'-toggle')
                       .addEventListener('toggle-check', e=> { 
                        toggleAnimationProp(toggle)
                        updateAnimDisplay()
                  }) 
            })  
             
            document.getElementById('animate-auto-toggle').addEventListener(
               'toggle-check', e=> {
                  if (e.detail.toggle)
                     enableAutoMode()
                  else
                     disableAutoMode()
                  updateAnimDisplay();
               }
            );
           
            
            
            const rowColIncr = (rowOrCol, e)=> { 
               console.log(e.detail.value);
               const currVal = Number(hypno.getAttribute(`num-${rowOrCol}s`)),
                     incr    = (e.detail.value === 'plus' ? 1 : -1),
                     newVal  = Math.max(1, Math.min(20, currVal + incr)); 
               document.getElementById(`${rowOrCol}s-display`).innerHTML = newVal;
               hypno.setRowOrCol(rowOrCol, newVal);
               //hypno.setAttribute(`num-${rowOrCol}s`, newVal)
            }
                        
            document.getElementById('rows-incrementer').addEventListener('increment', e=> rowColIncr('row', e))

            document.getElementById('columns-incrementer').addEventListener('increment',e=> rowColIncr('column', e))

            
            document.getElementById('edit-image-button').addEventListener('click', e=> { 
               if (upl.classList.contains('url-input') && upl.classList.contains('selecting')){
                  upl.classList.remove('url-input')
               }
               else if (upl.classList.contains('selecting')) {
                  upl.classList.remove('selecting')
               } else {
                  upl.classList.remove('url-input')
                  upl.classList.add('selecting')
               }  
            })
            

            function pauseAnimation() {
               if (intervalId!=null){
                  stopAnimation()
                  document.body.classList.add('no-transitions')
                  aniPause = true
               }
            }

            function restartAnimation(){
               document.body.classList.remove('no-transitions')
               if (aniPause == true) { startAnimation() }
            }


            const valDisplays = ((dict = {})=>{
               ['image-scale','zoom-amount','tile-width','canvas-rotation'].forEach(control=>{
                  dict[control] = document.getElementById(control+'-value-display')
               })
               return dict;
            })();
         
            [ 'image-scale-input-slider',
              'tile-width-input-slider',
              'zoom-amount-input-slider',
              'canvas-rotation-input-slider'].forEach(sliderId=>{
               const slider = document.getElementById(sliderId),
                     cssProp = sliderId.replace('-input-slider','');
               slider.addEventListener('range-change', ((timeoutId)=>
                  (e) => { 
                     if (e.detail.from === 'input' ) {
                        if (intervalId != null) pauseAnimation()
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(restartAnimation, 500); 
                     }    
                     const newVal = (e.detail.value + (slider.getAttribute('unit')));
                     setCssProp('--'+cssProp, newVal);  
                     valDisplays[cssProp].innerHTML = (cssProp.includes('rot') ? newVal.replace('deg','°') : newVal);
                  })())
               if (slider.hasAttribute('value')){
                  const newVal = (slider.getAttribute('value') + (slider.getAttribute('unit')));
                  valDisplays[cssProp].innerHTML = (cssProp.includes('rot') ? newVal.replace('deg','°') : newVal);
               }
            })
 
            setTimeout(()=>{
               for (let rowCol of ['rows','columns']) {
                  document.getElementById(rowCol+'-display').innerHTML = hypno.getAttribute('num-'+rowCol)
               }
            },100);

            setDashMin(origWidth)
            toggleDash('close')  
            enableAutoMode() 
            updateAnimDisplay()
            activateTool('move')
            
            /* if an image url is detected in url hash, try and load it */
            if (window.location.hash.replace('#','').startsWith('http') &&
               IMG_FILE_EXTENSIONS.includes(window.location.hash.split('.').at(-1))) { 
               document.querySelector('image-uploader').submitUrl(window.location.hash.replace('#',''))
            }
         })() 

      })()
   </script>

</html> 
